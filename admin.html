<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Parking Admin Panel</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

// ================= FIREBASE CONFIG =================
const firebaseConfig = {
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ================= FREE SLOT FUNCTION =================
async function freeSlot() {
  const input = document.getElementById("slotCode");
  const code = input.value.trim().toUpperCase();
  if (!/^[A-D]\d{2}$/.test(code)) {
    alert("Invalid format! Use A01–D24.");
    return;
  }

  const floor = code[0];
  const floorRef = ref(db, `parking/${floor}`);

  try {
    const snapshot = await get(floorRef);
    if (!snapshot.exists()) {
      alert(`Floor ${floor} not found in database.`);
      return;
    }

    const floorData = snapshot.val();
    const parked = floorData.parked_slots || [];
    let free = floorData.free_slots || [];

    if (!parked.includes(code)) {
      alert(`Slot ${code} is not currently parked.`);
      return;
    }

    const newParked = parked.filter(s => s !== code);
    if (!free.includes(code)) free.push(code);

    const newFree = free.sort((a,b) => parseInt(a.slice(1)) - parseInt(b.slice(1)));

    const updates = {
      parked_slots: newParked,
      free_slots: newFree,
      parked_count: newParked.length,
      free_count: newFree.length
    };

    await update(ref(db, 'parking'), { [floor]: updates, exit_gate: 1 });

    alert(`Slot ${code} freed! Exit gate opened.`);
    input.value = "";

    setTimeout(async () => {
      await update(ref(db, 'parking'), { exit_gate: 0 });
    }, 3000);

  } catch (error) {
    console.error("Firebase update error:", error);
    alert("Failed to update slot. Please try again.");
  }
}

// ================= PARK SLOT FUNCTION (ADD CAR) =================
async function parkSlot() {
  const input = document.getElementById("slotCode");
  const code = input.value.trim().toUpperCase();
  if (!/^[A-D]\d{2}$/.test(code)) {
    alert("Invalid format! Use A01–D24.");
    return;
  }

  const floor = code[0];
  const floorRef = ref(db, `parking/${floor}`);

  try {
    const snapshot = await get(floorRef);
    if (!snapshot.exists()) {
      alert(`Floor ${floor} not found in database.`);
      return;
    }

    const floorData = snapshot.val();
    let parked = floorData.parked_slots || [];
    let free = floorData.free_slots || [];

    if (parked.includes(code)) {
      alert(`Slot ${code} is already parked.`);
      return;
    }

    parked.push(code);
    parked = parked.sort((a,b) => parseInt(a.slice(1)) - parseInt(b.slice(1)));
    free = free.filter(s => s !== code);

    const updates = {
      parked_slots: parked,
      free_slots: free,
      parked_count: parked.length,
      free_count: free.length
    };

    await update(ref(db, 'parking'), { [floor]: updates, entry_gate: 1 });

    alert(`Car added to ${code}. Entry gate opened.`);
    input.value = "";

    setTimeout(async () => {
      await update(ref(db, 'parking'), { entry_gate: 0 });
    }, 3000);

  } catch (error) {
    console.error("Firebase update error:", error);
    alert("Failed to update slot. Please try again.");
  }
}

// ================= DIGITAL KEYBOARD =================
function appendKey(char) {
  const input = document.getElementById("slotCode");
  if (input.value.length >= 3) return;
  input.value += char.toUpperCase();
}

function backspace() {
  const input = document.getElementById("slotCode");
  input.value = input.value.slice(0, -1);
}

window.freeSlot = freeSlot;
window.parkSlot = parkSlot;
window.appendKey = appendKey;
window.backspace = backspace;
</script>

<style>
body { font-family: Arial, sans-serif; color: #fff; text-align: center; height: 100vh; margin: 0; display: flex; flex-direction: column; justify-content: center; background-color: #02000a; }
h1 { font-size: 2em; margin-bottom: 20px; }
input { font-size: 4em; padding: 10px; width: 300px; text-align: center; text-transform: uppercase; border-radius: 8px; color: white; background-color: #02000a; outline: none; border: none; }
button.submit-btn { margin-top: 20px; font-size: 1.2em; padding: 25px 150px; border: 2px solid #252525; border-radius: 8px; background-color: transparent; color: white; cursor: pointer; }
button.submit-btn:hover { color: #afafaf; }
.container { padding: 40px; display: inline-block; }
.keyboard { margin-top: 20px; display: grid; grid-template-columns: 80px 80px 80px 80px; gap: 15px; justify-content: center; }
.keyboard button { padding: 25px; font-size: 1.8em; border-radius: 12px; border: 2px solid #2e2e2e; background-color: transparent; color: rgb(206, 206, 206); cursor: pointer; }
.keyboard button:hover { color: #d6d6d6; border: 2px solid #2e2e2e; }
.backspace { color: #d6d6d6; border: 2px solid #2e2e2e; }
.backspace:hover { color: #d6d6d6; border: 2px solid #2e2e2e; }
</style>
</head>

<body>
<div class="container">
  <h1>Manage Parking Slot</h1>
  <input id="slotCode" maxlength="3" placeholder="A01">
  <div class="keyboard">
    <button onclick="appendKey('A')">A</button>
    <button onclick="appendKey('1')">1</button>
    <button onclick="appendKey('2')">2</button>
    <button onclick="appendKey('3')">3</button>
    <button onclick="appendKey('B')">B</button>
    <button onclick="appendKey('4')">4</button>
    <button onclick="appendKey('5')">5</button>
    <button onclick="appendKey('6')">6</button>
    <button onclick="appendKey('C')">C</button>
    <button onclick="appendKey('7')">7</button>
    <button onclick="appendKey('8')">8</button>
    <button onclick="appendKey('9')">9</button>
    <button onclick="appendKey('D')">D</button>
    <button onclick="appendKey('0')">0</button>
    <button class="backspace" onclick="backspace()">⌫</button>
    <button style="visibility:hidden;"></button>
  </div>

  <button class="submit-btn" onclick="parkSlot()">Park Slot</button>
  <button class="submit-btn" onclick="freeSlot()">Free Slot</button>
</div>
</body>
</html>
